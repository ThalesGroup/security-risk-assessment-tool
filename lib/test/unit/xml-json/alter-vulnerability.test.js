const alterVulnerability = require('../../../src/api/xml-json/alter-isra/alter-vulnerability');

describe('alterVulnerability', () => {
  it('sanitizes supportingAssetRef entries during import', () => {
    const vulnerabilities = [{
      projectName: ['demo project'],
      projectVersion: ['1.0'],
      vulnerabilityId: ['1'],
      vulnerabilityName: ['Demo'],
      vulnerabilityFamily: ['Input Validation Vulnerability'],
      vulnerabilityTrackingID: [''],
      vulnerabilityTrackingURI: ['https://example.com/ticket/1'],
      vulnerabilityCVE: ['CVSS_VECTOR'],
      vulnerabilityDescription: [''],
      vulnerabilityDescriptionAttachment: [''],
      supportingAssetRef: ['', '5', '   ', 'not-a-number', '6', null, undefined, 7],
      vulnerabilityCVSS: [{}],
      vulnerabilityCVEScoring: [{ cveScore: 4 }],
      overallScore: [''],
      overallLevel: ['Low']
    }];

    alterVulnerability('<ISRA></ISRA>', vulnerabilities);

    expect(vulnerabilities[0].supportingAssetRef).toEqual([5, 6, 7]);
  });

  it('removes empty entries even when they are not the first element', () => {
    const vulnerabilities = [{
      projectName: ['demo'],
      projectVersion: ['1.0'],
      vulnerabilityId: ['2'],
      vulnerabilityName: ['Demo'],
      vulnerabilityFamily: ['API Abuse'],
      vulnerabilityTrackingID: [''],
      vulnerabilityTrackingURI: [''],
      vulnerabilityCVE: ['CVSS_VECTOR'],
      vulnerabilityDescription: [''],
      vulnerabilityDescriptionAttachment: [''],
      supportingAssetRef: ['12', '', '  14 ', '', '18'],
      vulnerabilityCVSS: [{}],
      vulnerabilityCVEScoring: [{ cveScore: 1 }],
      overallScore: [''],
      overallLevel: ['Low']
    }];

    alterVulnerability('<ISRA></ISRA>', vulnerabilities);

    expect(vulnerabilities[0].supportingAssetRef).toEqual([12, 14, 18]);
  });

  it('returns an empty array when every reference is invalid', () => {
    const vulnerabilities = [{
      projectName: ['demo'],
      projectVersion: ['1.0'],
      vulnerabilityId: ['3'],
      vulnerabilityName: ['Demo'],
      vulnerabilityFamily: ['API Abuse'],
      vulnerabilityTrackingID: [''],
      vulnerabilityTrackingURI: [''],
      vulnerabilityCVE: ['CVSS_VECTOR'],
      vulnerabilityDescription: [''],
      vulnerabilityDescriptionAttachment: [''],
      supportingAssetRef: ['', '   ', 'not-a-number'],
      vulnerabilityCVSS: [{}],
      vulnerabilityCVEScoring: [{ cveScore: 1 }],
      overallScore: [''],
      overallLevel: ['Low']
    }];

    alterVulnerability('<ISRA></ISRA>', vulnerabilities);

    expect(vulnerabilities[0].supportingAssetRef).toEqual([]);
  });
});
